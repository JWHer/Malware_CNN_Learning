# Malware_CNN_Learning

PE 헤더 추출을 통한 윈도우 악성코드 탐지, 논문 발표까지  
ISSN 2005-0011, pp.431 - 434  

## 1. 악성코드탐지 with 딥러닝  

현재는 주요 악성코드의 해시값 등의 시그니처 기반 탐지를 한다. 새롭게 등장하는 악성코드를 탐지하기에는 적절하지 않은 것이다.

Deep neural network based malware detection using two dimensional binary program feature(Saxe et al)는 실행파일의 string extraction, import tables, byte n-gram, opcode,
byte entropy의 특징을 추출해 각 feature의 조합에 따른 탐지율을 비교한다. 
An investigation of byte n-gram features for malware classification(Raff et al)의 연구에서는 실행파일에 n-gram 특징을 추출하는 방법을 제안한다.  


## 2. 제안 모델  

<p align="center"><image src="https://raw.githubusercontent.com/JWHer/Malware_CNN_Learning/master/readme/framwork.png" width="40%"> </p>

> 1. 파일 특징 추출로 PE 포맷 추출과 n-grams 제작 단계로 나뉜다.  
> 2. 데이터의 이미지화 단계이다. 이 단계에서 PE 포맷의 byte는 문맥에서 등장할 확률에 따라 grayscale 하여 이미지로 변환된다.  
> 3. CNN의 학습이다. CNN은 filter를 사용하여 데이터의 특징을 추출한다. 따라서 사소한 내용의 차이(회전, 왜곡, 변형)가 있어도 특징을 검출하기 때문에 악성코드 변종에 대한 감지가 수월할 것으로 생각된다.  

## 왜 PE 포맷인가?  
PE 포맷은 윈도우즈 OS에 실행 파일 포맷으로 실행에 필요한 정보, 메모리 로드 위치, 사용하는 라이브러리, 실행시간에 결정되는 정보를 담은 구조체다. 
PE 포맷에서 DOS header, COFF, Optional header 부분을 추출해 총 328 bytes 배열을 얻게 된다. 이것은 실행 파일의 핵심적인 특징이며, 적은 분량이고, 일정한 크기를 가진다. 
일정한 길이를 가진다는 것은 신경망에 적용하기 쉽게 해준다  

## Convolutional Neural Network  

<p align="center"><image src="https://raw.githubusercontent.com/JWHer/Malware_CNN_Learning/master/readme/cnn.png" width="60%"> </p>  
  
*합성곱 연산 도식*  

Convolution은 특정한 필터값으로 입력 데이터에 대한 합성곱 연산을 수행한다. 따라서 필터에 따라 이미지 일부분이 강조되고 이는 특징을 추출하는 기능을 한다.  

## 3. 결과

<image src="https://raw.githubusercontent.com/JWHer/Malware_CNN_Learning/master/readme/ROC.png" width="40%"> <image src="https://raw.githubusercontent.com/JWHer/Malware_CNN_Learning/master/readme/ROC4.png" width="40%">  
제안 모델과 Raff의 모델에 대한 AUC 값을비교하였다.  

## 아쉬운점  
사실 이 논문은 악성코드에 대한 배경 지식이 부족한 상태로 여러 논문을 공부해 작성했다.  
모르는 도메인을 학습하게 된 이유는 데이터의 부족이 컸다...  고품질의 많은 데이터를 쓸 수 있었으면!  
또한, 어떤 feature를 추출할지, 신경망의 Hyper parameter는 어떻게 정해줄지 기존 연구조차 없다면 *(최근 Katib에 대해 알았다 시간이 되면 Katib에 대해 공부해보고 싶다)* 어떡해 해야할지 고민하게 되었고 Xgboost에 대해 추가로 공부했다.  

## Xgboost 코드 추가  
*현장 전문가에서 얻은 귀뜸*  
논문을 발표까지 마친 후 4개월 정도 에 현장 전문가에게 가장 성능이 좋은 모델에 대해 알 수 있었다. 따라서 내용을 추가한다.  
[코드](https://github.com/JWHer/Malware_CNN_Learning/blob/master/readme/XGBoost.py)

<p align="center"><image src="https://raw.githubusercontent.com/JWHer/Malware_CNN_Learning/master/readme/xgboost.png" width="40%"></p>  

xgboost는 여러개의 Decision Tree를 조합해서 사용하는 Ensemble모델이다. 다음과 같이 중요도에 따라 f-score를 준다.  
데이터 전처리를 수행하며 다수의 악성코드가 entry point를 조작하여 악성코드를 실행시키는 경우를 많이 봤는데, Xgboost의 f-score 결과도 entry point의 f-score가 가장 높았다.  

본 연구는 한국인터넷진흥원(KISA)에서 운영하는 정보보호 R&D 데이터셋 [대용량 정상/악성파일 I, 대용량 정상/악성파일 II, 대용량 정상/악성파일 III]을 활용하여 작성되었음
